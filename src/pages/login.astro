---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../supabaseClient";
import { ENV } from "../utils/env.util";

const { request, response } = Astro;
let message = "";
if (request.method === "POST") {
    const form = await request.formData();
    const email = form.get("email") as string;
    const password = form.get("password") as string;
    message = "000";
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
        });

        console.log("login data", { data, error });
        // headers.append('Set-Cookie', `foo=foo; HttpOnly`);
        response.headers.append(
            "Set-Cookie",
            `${ENV.AUTH_COOKIE_TOKEN}=${data?.session?.access_token}`
        );
    } catch (e) {
        console.error(e);
        message = "Wrong password or email";
    }

    return Astro.redirect('/profile');
}
---

<Layout title="Login">
    <h3>Sign in</h3>
    <form method="post">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" />
        <label for="password">Password</label>
        <input type="password" id="password" name="password" />
        <button type="submit">Login</button>
    </form>
    {message && <caption>{message}</caption>}<br />
</Layout>
